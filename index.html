<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunPower | Admin User Monitor</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "cf534965-d7ac-4aa4-acdd-8dbf30227a09",
        });
      });
    </script>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --sun-blue: #1e3a8a; --sun-yellow: #facc15; --dark-bg: #020617; --card-bg: #0f172a; }
        body { background-color: var(--dark-bg); font-family: 'Segoe UI', sans-serif; margin: 0; color: white; }
        
        .header { 
            padding: 15px 20px; background: var(--sun-blue); 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 3px solid var(--sun-yellow); position: sticky; top: 0; z-index: 100;
        }

        .stats-bar { background: #1e293b; padding: 10px 20px; font-size: 13px; color: #4ade80; display: flex; justify-content: space-between; }

        .user-container { padding: 15px; }

        .user-card {
            background: var(--card-bg); border-radius: 12px; padding: 15px; margin-bottom: 12px;
            border-left: 5px solid var(--sun-yellow); box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .user-name { font-size: 17px; font-weight: bold; color: var(--sun-yellow); }
        .user-balance { font-size: 18px; color: #4ade80; font-weight: bold; }

        .details-grid { 
            display: grid; grid-template-columns: 1fr; gap: 8px; 
            font-size: 13px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px;
        }

        .detail-item { color: #cbd5e1; display: flex; align-items: center; gap: 10px; }
        .detail-item i { color: var(--sun-yellow); width: 15px; }

        .loading-screen { text-align: center; padding: 50px; color: #94a3b8; font-size: 14px; }
        #totalCount { background: white; color: black; padding: 2px 10px; border-radius: 10px; font-weight: bold; }
        
        /* New User Flash Alert */
        .new-alert { color: #facc15; font-weight: bold; animation: blink 1s infinite; display: none; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center; gap:10px;">
        <i class="fas fa-user-shield" style="font-size: 20px; color: var(--sun-yellow);"></i>
        <h3 style="margin:0;">Admin Monitor</h3>
    </div>
    <div id="totalCount">0</div>
</div>

<div class="stats-bar">
    <span><i class="fas fa-bolt"></i> Live Connection Active</span>
    <span id="newBadge" class="new-alert">üö® NEW USER!</span>
</div>

<div class="user-container" id="userList">
    <div class="loading-screen">
        <i class="fas fa-spinner fa-spin"></i><br><br>
        ‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA3k5ByUuJ-1jtVovgZMxsw1LBaBkn_nDo",
        authDomain: "new-investment-web.firebaseapp.com",
        projectId: "new-investment-web",
        storageBucket: "new-investment-web.firebasestorage.app",
        messagingSenderId: "1078188475858",
        appId: "1:1078188475858:web:b3777ea127aae8e083740b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let isInitialLoad = true; 

    // ‡§®‡§µ‡•Ä‡§® ‡§Ø‡•Å‡§ú‡§∞‡•ç‡§∏‡§µ‡§∞ ‡§≤‡§ï‡•ç‡§∑ ‡§†‡•á‡§µ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä Snapshot Listener
    db.collection("users").orderBy("mobile", "desc").onSnapshot((querySnapshot) => {
        const userListDiv = document.getElementById('userList');
        const newBadge = document.getElementById('newBadge');
        
        // ‡§ú‡§∞ ‡§®‡§µ‡•Ä‡§® ‡§¨‡§¶‡§≤ ‡§ù‡§æ‡§≤‡§æ ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ (‡§®‡§µ‡•Ä‡§® ‡§Ø‡•Å‡§ú‡§∞ ‡•≤‡§° ‡§ù‡§æ‡§≤‡§æ ‡§§‡§∞)
        querySnapshot.docChanges().forEach((change) => {
            if (change.type === "added" && !isInitialLoad) {
                // ‡•ß. ‡§Æ‡•ã‡§¨‡§æ‡§à‡§≤‡§µ‡§∞ ‡§®‡•ã‡§ü‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§® ‡§™‡§æ‡§†‡§µ‡§æ
                showWebNotification(change.doc.data().name);
                
                // ‡•®. ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§®‡§µ‡§∞ ‡§¨‡•Ö‡§ú ‡§¶‡§æ‡§ñ‡§µ‡§æ
                newBadge.style.display = "inline";
                setTimeout(() => { newBadge.style.display = "none"; }, 5000);
            }
        });

        userListDiv.innerHTML = "";
        let count = 0;

        querySnapshot.forEach((doc) => {
            const user = doc.data();
            count++;
            
            const card = `
                <div class="user-card">
                    <div class="card-header">
                        <div class="user-name"><i class="fas fa-user-circle"></i> ${user.name || 'No Name'}</div>
                        <div class="user-balance">‚Çπ${user.balance || 0}</div>
                    </div>
                    <div class="details-grid">
                        <div class="detail-item"><i class="fas fa-phone"></i> Mobile: ${user.mobile || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-university"></i> Bank: ${user.bank_name || 'Not Linked'}</div>
                        <div class="detail-item"><i class="fas fa-id-card-alt"></i> A/C: ${user.account_number || 'N/A'}</div>
                        <div class="detail-item"><i class="fas fa-key"></i> IFSC: ${user.ifsc || 'N/A'}</div>
                    </div>
                </div>
            `;
            userListDiv.insertAdjacentHTML('beforeend', card);
        });

        document.getElementById('totalCount').innerText = count;
        isInitialLoad = false; 

        if(count === 0) {
            userListDiv.innerHTML = '<div class="loading-screen">‡§Ö‡§ú‡•Ç‡§® ‡§ï‡•ã‡§£‡•Ä‡§π‡•Ä ‡§Ø‡•Å‡§ú‡§∞ ‡§®‡§æ‡§π‡•Ä!</div>';
        }
    });

    // ‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞ ‡§®‡•ã‡§ü‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§® ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    function showWebNotification(userName) {
        if (!("Notification" in window)) return;
        
        if (Notification.permission === "granted") {
            new Notification("üö® New Member Joined!", {
                body: userName + " ‡§®‡•Å‡§ï‡§§‡§æ‡§ö SunPower ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡•≤‡§° ‡§ù‡§æ‡§≤‡§æ ‡§Ü‡§π‡•á.",
                icon: "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/pngs/solid/user-plus.png"
            });
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission();
        }
    }
</script>

</body>
</html>
