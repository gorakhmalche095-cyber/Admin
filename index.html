<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunPower Admin | Firestore Monitor</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-firestore-compat.js"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --sun-blue: #1e3a8a; --sun-yellow: #facc15; --dark-bg: #020617; --card-bg: #0f172a; }
        body { background-color: var(--dark-bg); font-family: 'Segoe UI', sans-serif; margin: 0; color: white; }
        .header { padding: 15px; background: var(--sun-blue); display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--sun-yellow); position: sticky; top: 0; z-index: 100; }
        .user-card { background: var(--card-bg); border-radius: 12px; padding: 15px; margin: 10px; border-left: 5px solid var(--sun-yellow); animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .user-name { color: var(--sun-yellow); font-weight: bold; font-size: 16px; }
        #totalCount { background: white; color: black; padding: 2px 12px; border-radius: 15px; font-weight: bold; }
        .status { font-size: 12px; padding: 10px; color: #4ade80; text-align: center; background: #1e293b; }
    </style>
</head>
<body>

<div class="header">
    <h3><i class="fas fa-user-shield"></i> Admin Monitor</h3>
    <div id="totalCount">0</div>
</div>
<div class="status" id="dbStatus"><i class="fas fa-sync-alt fa-spin"></i> Firestore ‡§∂‡•Ä ‡§ï‡§®‡•á‡§ï‡•ç‡§ü ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</div>

<div id="userList">
    <div style="text-align:center; padding:50px; color: #94a3b8;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</div>
</div>

<script>
    // ‡•®. ‡§§‡•Å‡§ù‡•Ä Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyA3k5ByUuJ-1jtVovgZMsw1LBaBkn_nDo",
        authDomain: "new-investment-web.firebaseapp.com",
        projectId: "new-investment-web",
        storageBucket: "new-investment-web.appspot.com",
        messagingSenderId: "1078188475858",
        appId: "1:1078188475858:web:b3777ea127aae8e083740b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); // Firestore database ‡§∏‡•Å‡§∞‡•Å ‡§ï‡•á‡§≤‡§æ

    const ONESIGNAL_APP_ID = "cf534965-d7ac-4aa4-acdd-8dbf30227a09";
    const ONESIGNAL_REST_KEY = "os_v2_app_z5juszoxvrfkjlg5rw7tait2bebfjphn2f7ebpni33n3hafmxh2hi4qpnhhcnlg5bacehq4ntkbpdgef3pahibrorcyypk64a56ksby";

    let isInitialLoad = true;

    // ‡•©. Firestore ‡§Æ‡§ß‡•Ç‡§® 'users' ‡§ï‡§≤‡•á‡§ï‡•ç‡§∂‡§®‡§ö‡•á Realtime ‡§Ö‡§™‡§°‡•á‡§ü‡•ç‡§∏ ‡§Æ‡§ø‡§≥‡§µ‡§£‡•á
    db.collection("users").onSnapshot((querySnapshot) => {
        document.getElementById('dbStatus').innerHTML = '<i class="fas fa-check-circle"></i> Firestore Live Connected';
        
        const userListDiv = document.getElementById('userList');
        userListDiv.innerHTML = "";
        let count = 0;

        // ‡§®‡§µ‡•Ä‡§® ‡§Ø‡•Å‡§ú‡§∞ ‡•≤‡§° ‡§ù‡§æ‡§≤‡§æ ‡§ï‡§æ ‡§§‡•á ‡§§‡§™‡§æ‡§∏‡§£‡•á
        querySnapshot.docChanges().forEach((change) => {
            if (change.type === "added" && !isInitialLoad) {
                console.log("New User:", change.doc.data().name);
                sendPushNotification(change.doc.data().name);
            }
        });

        // ‡§∏‡§∞‡•ç‡§µ ‡§Ø‡•Å‡§ú‡§∞‡•ç‡§∏‡§ö‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§¨‡§®‡§µ‡§£‡•á
        querySnapshot.forEach((doc) => {
            const user = doc.data();
            count++;
            const card = `
                <div class="user-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="user-name"><i class="fas fa-user-circle"></i> ${user.name || 'Unknown'}</span>
                        <span style="color:#4ade80; font-weight:bold;">‚Çπ${user.balance || 0}</span>
                    </div>
                    <div style="font-size:13px; color:#cbd5e1; margin-top:8px;">
                        <i class="fas fa-phone-alt"></i> ${user.mobile || 'N/A'}<br>
                        <i class="fas fa-university"></i> ${user.bank_name || 'N/A'}
                    </div>
                </div>
            `;
            userListDiv.insertAdjacentHTML('afterbegin', card);
        });

        document.getElementById('totalCount').innerText = count;
        isInitialLoad = false;

        if(count === 0) {
            userListDiv.innerHTML = '<div style="text-align:center; padding:50px;">‡§Ö‡§ú‡•Ç‡§® ‡§ï‡•ã‡§£‡•Ä‡§π‡•Ä ‡§Æ‡•á‡§Ç‡§¨‡§∞ ‡§®‡§æ‡§π‡•Ä.</div>';
        }
    }, (error) => {
        console.error("Firestore Error: ", error);
        document.getElementById('dbStatus').innerHTML = '<i class="fas fa-exclamation-triangle" style="color:red;"></i> Rules ‡§ö‡•á‡§ï ‡§ï‡§∞‡§æ!';
    });

    // ‡§µ‡§®‡§∏‡§ø‡§ó‡•ç‡§®‡§≤ ‡§®‡•ã‡§ü‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§® ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    function sendPushNotification(userName) {
        fetch("https://onesignal.com/api/v1/notifications", {
            method: "POST",
            headers: {
                "Content-Type": "application/json; charset=utf-8",
                "Authorization": "Basic " + ONESIGNAL_REST_KEY
            },
            body: JSON.stringify({
                app_id: ONESIGNAL_APP_ID,
                included_segments: ["Total Subscriptions"], 
                contents: { "en": "üö® ‡§®‡§µ‡•Ä‡§® ‡§Æ‡•á‡§Ç‡§¨‡§∞: " + userName + " ‡§®‡•Å‡§ï‡§§‡§æ‡§ö ‡§ú‡•â‡§à‡§® ‡§ù‡§æ‡§≤‡§æ ‡§Ü‡§π‡•á!" },
                headings: { "en": "SunPower Alert" }
            })
        })
        .then(response => response.json())
        .then(data => console.log("Sent:", data));
    }
</script>

</body>
</html>
